YAHOO.namespace("coment");coment=YAHOO.coment;YAHOO.namespace("coment.core");YAHOO.namespace("coment.util");core=coment.core;util=coment.util;YAHOO.namespace("coment.cst");coment.cst={framed:true,debug:false,maxCallDuration:5000,idsSeparator:",",textNodeId:"text",print_comments:"c_comments",textNodeCls:"text",textWordIdPref:"w_",dispIdPref:"disp_",textType:"T",dateType:"D",attachDDGroup:"attach_DD_group",attachPositionOffset:3,pathToTarget:"/site_media/client",attachListInitialHeight:420,westInitialWidth:350,scrollbarWidth:19,currentSelDispLength:100,maxSelectedTxtLength:2000,colorizePacketSize:10,colorizePaintTimeout:10};if(!core.CookieHandler){core.CookieHandler=new function(){this.set=function(A,B){if(typeof B=="undefined"||B===null){this.clear(A);return ;}this.setCookie(A,B);};this.clear=function(A){this.clearCookie(A);};this.readCookies=function(){var C={};var F=document.cookie+";";var B=/\s?(.*?)=(.*?);/g;var E;while((E=B.exec(F))!=null){var A=E[1];var D=E[2];if(A&&A.substring(0,7)=="coment-"){C[A.substr(7)]=this.decodeValue(D);}}return C;};this.setCookie=function(A,B){document.cookie="coment-"+A+"="+this.encodeValue(B)+"; expires=Thu, 2 Aug 2030 20:47:11 UTC; path=/";};this.clearCookie=function(A){document.cookie="coment-"+A+"=null; expires=Thu, 01-Jan-70 00:00:01 GMT; path=/";};this.decodeValue=function(A){var J=/^(a|n|d|b|s|o)\:(.*)$/;var C=J.exec(unescape(A));if(!C||!C[1]){return ;}var F=C[1];var H=C[2];switch(F){case"n":return parseFloat(H);case"d":return new Date(Date.parse(H));case"b":return(H=="1");case"a":var G=[];var I=H.split("^");for(var B=0,D=I.length;B<D;B++){G.push(this.decodeValue(I[B]));}return G;case"o":var G={};var I=H.split("^");for(var B=0,D=I.length;B<D;B++){var E=I[B].split("=");G[E[0]]=this.decodeValue(E[1]);}return G;default:return H;}};this.encodeValue=function(C){var B;if(typeof C=="number"){B="n:"+C;}else{if(typeof C=="boolean"){B="b:"+(C?"1":"0");}else{if(C instanceof Date){B="d:"+C.toGMTString();}else{if(C instanceof Array){var F="";for(var E=0,A=C.length;E<A;E++){F+=this.encodeValue(C[E]);if(E!=A-1){F+="^";}}B="a:"+F;}else{if(typeof C=="object"){var F="";for(var D in C){if(typeof C[D]!="function"){F+=D+"="+this.encodeValue(C[D])+"^";}}B="o:"+F.substring(0,F.length-1);}else{B="s:"+C;}}}}}return escape(B);};};}if(!core.User){core.User=new function(){this.getCookieAuthor=function(){var A=core.CookieHandler.readCookies()["author"];if(A==null){A="";}return A;};this.getCookieEMail=function(){var A=core.CookieHandler.readCookies()["email"];if(A==null){A="";}return A;};this.record=function(B,A){core.CookieHandler.set("author",B);core.CookieHandler.set("email",A);};};}so_dis_datas=null;core.CommentAttachMgr=function(A){this._attachController=A;this._cacheColoredIds={};};core.CommentAttachMgr.prototype={onFilterMgrApply:function(B,A,C){C.clear();},_impCleanAttachFields:function(){YAHOO.util.Dom.get("edit_current_sel").innerHTML=core.LayoutMgr.getInitialSelectionContent();YAHOO.util.Dom.get("current_sel").innerHTML=core.LayoutMgr.getInitialSelectionContent();YAHOO.util.Dom.get("add_comment_title").value="";YAHOO.util.Dom.get("add_comment_text").value="";YAHOO.util.Dom.get("add_comment_tags").value="";},_impGetAddAttachDoneMsg:function(){},_addAttach:function(B,C){var A=new core.Attach(B,this);A.addMe(C);this._attachController.addAttach(A);},_readDate:function(A){A.created=coment.util.dateFromString(A.created);return A;},updateAttachCount:function(){var A=Ext.ComponentMgr.get("attachsPanel").items.length;core.LayoutMgr.updatePanelTitle("attachsPanel",gettext("List")+" ("+A+")");},_retrieveAttachsReturns:function(A){var C=A["attachs"];for(var B=0;B<C.length;B++){var D=(B==(C.length-1));this._addAttach(this._readDate(C[B]),D);}for(var B=0;B<C.length-1;B++){this._attachController.getAttach(C[B].id).connect();}Ext.ComponentMgr.get("attachsregion").el.unmask();},updateAttachState:function(B,C){var A=core.ServerExchange.send("updateAttachState",{"comment_id":B,"state_id":C},this.updateAttachStateReturns,this,gettext("comment state changed"),gettext("comment state could not be changed"));},updateAttachStateReturns:function(A){this._attachController.updateAttach(this._readDate(A["attach"]));},updateDiscussionItemState:function(B,C){var A=core.ServerExchange.send("updateDiscussionItemState",{"discussionitem_id":B,"state_id":C},this.updateDiscussionItemStateReturns,this,gettext("reply state changed"),gettext("reply state could not be changed"));},updateDiscussionItemStateReturns:function(A){this._attachController.updateDiscussionItem(this._readDate(A["discussionitem"]));},_retrieveAttachs:function(G){var F=core.FilterMgr.getCachedFilterData();F.word=G;if(!sv_so_b){var B=core.ServerExchange.send("getAttachsOnWord",F,this._retrieveAttachsReturns,this,null,gettext("comments could not be retrieved"));}else{var A=[];var D=Ext.util.JSON.decode(this.so_json_datas);for(var C=0;C<D["attachs"].length;C++){var E=D["attachs"][C];if(E.start_word<=G&&E.end_word>=G){A.push(E);}}this._retrieveAttachsReturns({"attachs":A});}},_colorizeNode:function(C,A){var B=util.getElt(C);if(A!=null){if(this._cacheColoredIds[C]!=A){this._cacheColoredIds[C]=A;B.setStyle("background-color",A);B.setStyle("cursor","pointer");}}else{if(this._cacheColoredIds[C]){delete this._cacheColoredIds[C];B.setStyle("background-color","");B.setStyle("cursor","");}}},_color:function(G,A){var E=[];for(var D in G){E[E.length]=D;}var F=this;var C=0;var B=function(){while(C<E.length){var H=E[C];var I=G[H];F._colorizeNode(H,I);++C;if((!A)&&((C%coment.cst.colorizePacketSize)==0)){window.setTimeout(B,coment.cst.colorizePaintTimeout);break;}}if(C==E.length){F._attachController._showAttachTextPart(F._attachController._activeAttach,true);}};B();},_colorizeOccurences:function(H,I,C){var G={};if(H==-1){for(F in this._cacheColoredIds){G[F]=null;}}else{for(var B=H;B<=I;B++){var F=coment.util.fromWordToMarkerId(B);G[F]=null;}}for(var E=0;E<C.length;E++){var D=C[E];var A=coment.util.testColorFunction1(D.nbWord);for(var B=D.startWord;B<=D.endWord;B++){var F=coment.util.fromWordToMarkerId(B);G[F]=A;}}this._color(G);},populateTagCloud:function(){if(!sv_so_b){var A=core.ServerExchange.send("getTagCloud",{},this._populateTagCloudReturns,this,null,gettext("tag cloud could not be retrieved"));}else{this._populateTagCloudReturns(Ext.util.JSON.decode(this.so_json_datas));}},_populateTagCloudReturns:function(C){var B=C["tags"];var E="";for(var D=0;D<B.length;D++){var A=B[D];E=E+"<span id = 'tag-"+A.id+"' class='tagsize"+A.font_size+"'>"+A.name+"</span>&nbsp; ";}if(E==""){E=gettext("no comment has been tagged yet");}Ext.ComponentMgr.get("tagcloud").body.update(E);core.LayoutMgr.doLayout();},tagclicked:function(A){var C=YAHOO.util.Event.getTarget(A);if(C&&C.id.indexOf("tag-")==0){var B=C.id.substring(4);core.FilterMgr.applytagbtnclick(B);}},_retrieveOccsReturns:function(B){var D=B["fromWord"];var C=B["toWord"];var A=B["occs"];this._colorizeOccurences(D,C,A);this._retrieveAttachsReturns(B);},_retrieveOccs:function(H,G){var E=core.FilterMgr.getCachedFilterData();E.fromWord=H;E.toWord=G;if(!sv_so_b){var B=core.ServerExchange.send("getOccs",E,this._retrieveOccsReturns,this,null,gettext("comments could not be retrieved"));}else{if(H!=-1){alert("OHHHHHHHHHHHHH from != -1");}this.so_json_datas=coment.util.getElt("so_datas").dom.innerHTML;var D=Ext.util.JSON.decode(this.so_json_datas);so_dis_datas=D["discussionItems"];var C=D["tags"];var F=core.So_Computation.so_filter(E,D["attachs"],so_dis_datas,C);var A=core.So_Computation.so_computeOccs(F);D["attachs"]=F;D["occs"]=A;this._retrieveOccsReturns(D);}},renderOccurences:function(){Ext.ComponentMgr.get("attachsregion").el.mask(Ext.get("loadingindicatormsg").dom.innerHTML,"x-mask-loading");this._retrieveOccs(-1,-1);},clear:function(C,A){var D=this._attachController.getAttachs();for(var E in D){var B=D[E];this._attachController.removeAttach(B);B.removeMe();}},occClick:function(B,A){if(this._cacheColoredIds[B]){Ext.ComponentMgr.get("attachsregion").expand();this.clear();core.LayoutMgr.activateAttachListTab();var C=coment.util.fromMarkerIdToWord(B);this._retrieveAttachs(C);YAHOO.util.Event.preventDefault(A);}},_getFormFieldValue:function(B){var A=null;var C=YAHOO.util.Dom.get(B);if(C){A=C.value;}return A;},validateAuthor:function(B,D,E){if(!sv_loggedIn){var C=B.value;if(!coment.util.checkNonEmpty(C)){E[E.length]=[B.id,gettext("field is required")];}var A=D.value.toLowerCase();if(!coment.util.checkEmail(A)){E[E.length]=[D.id,gettext("email is invalid")];}}},_clientValidateSelection:function(C,B){var A=YAHOO.util.Dom.get(B).innerHTML;if(A==core.LayoutMgr.getInitialSelectionContent()){C[C.length]=[B,gettext("Select the part you wish to comment in the text diplayed on the right")];}},validateComment:function(D,C,E){var B=D.value;if(!coment.util.checkNonEmpty(B)){E[E.length]=[D.id,gettext("field is required")];}var A=C.value;if(!coment.util.checkNonEmpty(A)){E[E.length]=[C.id,gettext("field is required")];}return E;},_saveAttachReturns:function(B){this._impCleanAttachFields();if(B==null){alert(gettext("Thank you for your comment. It is being held for moderation."));}else{var A=B;this._retrieveOccs(A.start_word,A.end_word);this.clear();core.LayoutMgr.activateAttachListTab();this._addAttach(this._readDate(A),true);this.populateTagCloud();}},_getCurrentEditAttachId:function(){return YAHOO.util.Dom.get("edit_attach_id").value;},_getCurrentEditDIId:function(){return YAHOO.util.Dom.get("edit_di_id").value;},_getCurrentEditIsReply:function(){return YAHOO.util.Dom.get("edit_is_reply").value;},_validateTagReturnsFromEdit:function(E){if(E!=""){this._displayFormErrors([["add_comment_tags",E]]);}else{var A=this._getCurrentEditIsReply();var G=this._getCurrentEditAttachId();var B=-1;var H=-1;if(A==1){G=this._getCurrentEditDIId();}else{if(Ext.fly("edit_modif_scope").dom.checked){B=core.SelectionMgr.getSelectionFromWord();H=core.SelectionMgr.getSelectionToWord();}}var F=YAHOO.util.Dom.get("edit_comment_title").value;var D=YAHOO.util.Dom.get("edit_comment_text").value;var I=Ext.util.Format.trim(YAHOO.util.Dom.get("edit_comment_tags").value);var C=core.ServerExchange.send("editAttach",{"comment_id":G,"is_reply":A,"title":F,"content":D,"start_word":B,"end_word":H,"tags":I},this.editAttachReturns,this,gettext("comment changed"),gettext("comment could not be changed"));}},_validateTagReturnsFromAdd:function(D){if(D!=""){this._displayFormErrors([["add_comment_tags",D]]);}else{var E="";var C="";if(!sv_loggedIn){E=Ext.util.Format.trim(this._getFormFieldValue("add_author"));C=Ext.util.Format.trim(this._getFormFieldValue("add_email"));core.User.record(E,C);}var B={"title":YAHOO.util.Dom.get("add_comment_title").value,"content":YAHOO.util.Dom.get("add_comment_text").value,"tags":Ext.util.Format.trim(YAHOO.util.Dom.get("add_comment_tags").value),"start_word":core.SelectionMgr.getSelectionFromWord(),"end_word":core.SelectionMgr.getSelectionToWord(),"username":E,"email":C};var A=core.ServerExchange.send("addAttach",B,this._saveAttachReturns,this,gettext("comment added"),gettext("comment could not be added"));}},_displayFormErrors:function(C){for(var A=0;A<C.length;A++){var B=YAHOO.util.Dom.get("error_"+C[A][0]);B.innerHTML=C[A][1];coment.util.displayYesNo(B,true);}},_cleanFormErrors:function(C){var B=YAHOO.util.Dom.getElementsByClassName("field_error","div",C);for(var A=0;A<B.length;A++){coment.util.displayYesNo(B[A],false);}},editAttach:function(A,C,D,F,E,B){core.LayoutMgr.unhideEditAttachTab();this._cleanFormErrors("edit_attach_top");Ext.fly("edit_modif_scope").dom.checked=false;this.editAttachModifScopeClick();YAHOO.util.Dom.get("edit_attach_id").value=A;YAHOO.util.Dom.get("edit_di_id").value=C;YAHOO.util.Dom.get("edit_is_reply").value=D;if(D==1){Ext.fly("edit_attach_sel").addClass("displaynone");}else{Ext.fly("edit_attach_sel").removeClass("displaynone");}YAHOO.util.Dom.get("edit_comment_title").value=F;YAHOO.util.Dom.get("edit_comment_text").value=E;YAHOO.util.Dom.get("edit_comment_tags").value=B;},editAttachReturns:function(C){if(C["attach"]){YAHOO.util.Dom.get("edit_current_sel").innerHTML=core.LayoutMgr.getInitialSelectionContent();YAHOO.util.Dom.get("current_sel").innerHTML=core.LayoutMgr.getInitialSelectionContent();var B=this._readDate(C["attach"]);var F=-1;var G=-1;var I=this._attachController.getAttach(B.id);if(I){F=I.getStartWord();G=I.getEndWord();}this._attachController._showAttachTextPart(this._attachController._activeAttach,false);this._attachController.updateAttach(B);var H=this._attachController.getAttach(B.id);if(H){H.refreshMe();if(F!=-1){var A=H.getStartWord();var J=H.getEndWord();this._retrieveOccs(Math.min(F,A),Math.max(G,J));}}}if(C["discussionitem"]){var E=this._readDate(C["discussionitem"]);this._attachController.updateDiscussionItem(E);var D=this._attachController.getDiscussionItem(E.id);if(D){D.refreshMe();}}core.LayoutMgr.hideEditAttachTab();this.populateTagCloud();},editAttachModifScopeClick:function(){if(Ext.fly("edit_modif_scope").dom.checked){Ext.fly("edit_current_sel").removeClass("displaynone");Ext.fly("edit_help_current_sel").removeClass("displaynone");}else{Ext.fly("edit_current_sel").addClass("displaynone");Ext.fly("edit_help_current_sel").addClass("displaynone");}},editAttachButtonClick:function(){core.SelectionMgr.clearSelection();this._cleanFormErrors("edit_attach_top");var C=[];if(Ext.fly("edit_modif_scope").dom.checked){this._clientValidateSelection(C,"edit_current_sel");}this.validateComment(YAHOO.util.Dom.get("edit_comment_title"),YAHOO.util.Dom.get("edit_comment_text"),C);if(C.length){this._displayFormErrors(C);}else{var B=Ext.util.Format.trim(YAHOO.util.Dom.get("edit_comment_tags").value);var A=core.ServerExchange.send("validateTags",{"tags":B},this._validateTagReturnsFromEdit,this);}},editCancelAttachButtonClick:function(){core.LayoutMgr.hideEditAttachTab();},addAttachButtonClick:function(){core.SelectionMgr.clearSelection();this._cleanFormErrors("add_attach_top");var C=[];this._clientValidateSelection(C,"current_sel");this.validateComment(YAHOO.util.Dom.get("add_comment_title"),YAHOO.util.Dom.get("add_comment_text"),C);if(C.length){this._displayFormErrors(C);}else{var B=Ext.util.Format.trim(YAHOO.util.Dom.get("add_comment_tags").value);var A=core.ServerExchange.send("validateTags",{"tags":B},this._validateTagReturnsFromAdd,this);}},deleteAttachReturns:function(C){var D=C["attachId"];var A=this._getCurrentEditAttachId();if((A==D)){core.LayoutMgr.hideEditAttachTab();}var B=this._attachController.getAttach(D);if(B){this._retrieveOccs(B.getStartWord(),B.getEndWord());this._attachController.removeAttach(B);B.removeMe();}this.populateTagCloud();},deleteAttach:function(B){var A=core.ServerExchange.send("deleteAttach",{"comment_id":B.getId()},this.deleteAttachReturns,this,gettext("comment deleted"),gettext("comment could not be deleted"));},setEditability:function(B){var C=null;var D=null;if(B){if(B.hasClass("disp_discussionitem")){var A=B.id.substr("disc-".length);C=this._attachController.getDiscussionItem(A);D=C.getDispId();}else{var A=B.id.substr("comment-".length);C=this._attachController.getAttach(A);D=C.getListId();}}if(C!=null&&D!=null){if(C.couldBeEdited(false)){Ext.get("delete-"+D).removeClass("displaynone");Ext.get("edit-"+D).removeClass("displaynone");}else{Ext.get("delete-"+D).addClass("displaynone");Ext.get("edit-"+D).addClass("displaynone");}}},deleteDiscussionItemReturns:function(C){var F=C["discussionItemId"];var A=this._getCurrentEditDIId();if((A==F)){core.LayoutMgr.hideEditAttachTab();}var E=this._attachController.getDiscussionItem(F);if(E){var B=E.getParentAttachId();var D=null;var G=Ext.get(E.getDispId());if(G){previousElt=G.prev(".disp_discussionitem",false);}if(previousElt==null){previousElt=G.findParent(".disp_comment",10,true);}var H=this._attachController.getAttach(B);if(H){H.deleteReply(E);}this._attachController.removeDiscussionItem(F);this.setEditability(previousElt);}},deleteDiscussionItem:function(B){var A=core.ServerExchange.send("deleteDiscussionItem",{"discussionitem_id":B.getId()},this.deleteDiscussionItemReturns,this,gettext("reply deleted"),gettext("could not delete reply"));},switchSelect:function(B,C,A){coment.util.displayYesNo(B,A);coment.util.displayYesNo(C,!A);},toStateChoice:function(B,C,D){C.selectedIndex=0;for(var A=0;A<C.options.length;A++){if(C.options[A].value==D){C.selectedIndex=A;break;}}this.switchSelect(B,C,false);},toCurrentState:function(D,E,G,F,A,C){D.innerHTML=E.options[E.selectedIndex].innerHTML;this.switchSelect(D,E,true);var B=E.options[E.selectedIndex].value;if(G!=B){A.call(C,F,B);}}};if(!core.ServerExchange){core.ServerExchange=new function(){this.isCallInProgress=function(){if(this.oo){return YAHOO.util.Connect.isCallInProgress(this.oo);}return false;};this.callIsInProgress=function(){if(this.isCallInProgress()){core.LayoutMgr.displayErrorMsg(gettext("Please wait ..."));return true;}return false;};this.send=function(G,D,C,J,A,F,E){var B=true;if(E===true){B=!this.isCallInProgress();}if(B){var H=J||this;var I={success:function(L){if(A){core.LayoutMgr.displayInfoMsg(A);}var K={};if(L.responseText){K=Ext.util.JSON.decode(L.responseText);}C.call(this,K);},failure:function(L){var K=L.status;if(K=403){core.LayoutMgr.displayErrorMsg(gettext("unauthorized"));}else{if(F){core.LayoutMgr.displayErrorMsg(F);}else{core.LayoutMgr.displayErrorMsg(gettext("unknown error"));}}},scope:H};D["versionId"]=sv_versionId;D["fun"]=G;this.oo=YAHOO.util.Connect.asyncRequest("post","/client/",I,Ext.urlEncode(D));}return B;};};}core.AttachController=function(){this._activeAttach=null;this._attachs={};this._discussionItems={};this._computedResponseTitle=null;};core.AttachController.prototype={clear:function(A){this.removeAttachs();this.setActiveAttach(null);},getAttachs:function(){return this._attachs;},getAttach:function(A){return this._attachs[A];},getDiscussionItem:function(A){return this._discussionItems[A];},getActiveAttach:function(){return this._activeAttach;},setActiveAttach:function(A){if(this._activeAttach){Ext.fly(this._activeAttach.getPanelId()).removeClass("selectAtt2");this._showAttachTextPart(this._activeAttach,false);this._activeAttach=null;}if(A){Ext.fly(A.getPanelId()).addClass("selectAtt2");this._activeAttach=A;this._showAttachTextPart(this._activeAttach,true);}},addDiscussionItem:function(A){this._discussionItems[A.getId()]=A;},removeDiscussionItem:function(A){di=this._discussionItems[A];if(di){delete this._discussionItems[A];}},updateAttach:function(A){if(this._attachs[A.id]){this._attachs[A.id].setAttach(A);}},updateDiscussionItem:function(A){this._discussionItems[A.id].setDiscussionItem(A);},addAttach:function(A){this._attachs[A.getId()]=A;},removeAttach:function(A){if(this._activeAttach==A){this.setActiveAttach(null);}for(var B in this._discussionItems){if(this._discussionItems[B].getParentAttachId()==A.getId()){this.removeDiscussionItem(this._discussionItems[B]);}}delete this._attachs[A.getId()];},removeAttachs:function(){for(var A in this._attachs){this.removeAttach(this._attachs[A]);}},_computeTextPartColor:function(E,A){var F=parseInt(E.getColor("background-color","FFFFFF",""),16);var C=E.hasClass("selected_textpart");if((C&&!A)||(!C&&A)){if(C){E.removeClass("selected_textpart");}else{E.addClass("selected_textpart");}var D=(A)?parseInt("-27F3C3",16):parseInt("27F3C3",16);F=F+D;}var B=F.toString(16);while(B.length<6){B="0"+B;}return"#"+B;},_showAttachTextPart:function(B,A){if(B){var C=B.getStartWord();for(var H=C;H<B.getEndWord()+1;H++){var E=coment.util.fromWordToMarkerId(H);var D=util.getElt(E);if(A){if(H==C){var G=D.getXY();util.getTextWindow().scrollTo(G[0],G[1]-100);}var F=this._computeTextPartColor(D,A);D.setStyle({"background-color":F});}else{var F=this._computeTextPartColor(D,A);D.setStyle({"background-color":F});}}}}};core.DiscussionItem=function(B,A){this._discussionItem=B;this._dispId="disc-"+this._discussionItem.id;this._attachMgr=A;this._tpl=new Ext.DomHelper.Template('<div id="{id}" class="disp_discussionitem"><span id="delete-{id}" class="comment_btn comment_delete yunselectable {vis_remclass}" title="{delete_reply_tooltip}"><pre>   </pre></span><span id="edit-{id}" class="comment_btn comment_edit yunselectable {vis_remclass}" title="{edit_reply_tooltip}"><pre>   </pre></span><select id="select_state-{id}" class="displaynone comment_wfstate_select comment_btn">{select_options}</select><span id="current_state-{id}" class="comment_wfstate comment_btn {vis_manclass}" title="{change_wfstate_tooltip}">{current_state}</span><div id="reply_title-{id}" class="comment_title_cls yunselectable">{title}</div><div class="comment_authordate_cls yunselectable">{authordate}</div><div id="reply_text-{id}" class="comment_text_cls yunselectable">{text}</div><div id="reply_tags-{id}" class="comment_tags_cls yunselectable">{thetags}</div></div>');this._tpl.compile();};core.DiscussionItem.prototype={couldBeEdited:function(D){var B=false;if(sv_remComPerm){B=true;}else{if(sv_loggedIn&&this._discussionItem["username"]==sv_username&&this._discussionItem.state_id==sv_wrkf_initialstateid){var A=this._attachMgr._attachController.getAttach(this.getParentAttachId());if(A.attach.discussion_count==1){B=true;}else{var C=Ext.get("discs-comment-"+A.getId());if(C){if(D){B=(C.dom.childNodes.length==(A.attach.discussion_count-1));}else{B=(C.dom.childNodes[C.dom.childNodes.length-1].id==this._dispId);}}}}}return B;},toDom:function(){var B=coment.util.getAuthorAndDate(this._discussionItem);var E=(this.couldBeEdited(true))?"":"displaynone";var D=(sv_so_b||sv_manageComPerm)?"":"displaynone";var A=this._getTags();var C={id:this._dispId,authordate:B,title:this._discussionItem.title,delete_reply_tooltip:gettext("delete reply"),edit_reply_tooltip:gettext("edit comment"),text:this._discussionItem.content,vis_remclass:E,vis_manclass:D,thetags:A,change_wfstate_tooltip:gettext("click to change"),select_options:core.TextMgr.getStateOptions(),current_state:core.TextMgr.getStateName(this._discussionItem.state_id)};return this._tpl.applyTemplate(C);},_getTags:function(){var A=this._discussionItem.tags;if(A!=""){A=gettext("tags:")+A;}return A;},deleteMe:function(A){if(!core.ServerExchange.callIsInProgress()){if(confirm(gettext("Are you sure you want to delete this reply ?"))){this._attachMgr.deleteDiscussionItem(this);this._attachMgr.populateTagCloud();}YAHOO.util.Event.stopPropagation(A);}},editMe:function(A){if(!core.ServerExchange.callIsInProgress()){this._attachMgr.editAttach(this.getParentAttachId(),this.getId(),1,this._discussionItem.title,this._discussionItem.content,this._discussionItem.tags);}},getId:function(){return this._discussionItem.id;},getParentAttachId:function(){return this._discussionItem.comment_id;},getState:function(){return this._discussionItem.state;},isVisible:function(){return this._discussionItem.state.visible;},getDispId:function(){return this._dispId;},setDiscussionItem:function(A){return this._discussionItem=A;},toStateChoice:function(C){var B=YAHOO.util.Dom.get("current_state-"+this._dispId);var A=YAHOO.util.Dom.get("select_state-"+this._dispId);this._attachMgr.toStateChoice(B,A,this._discussionItem.state_id);},toCurrentState:function(C){if(!core.ServerExchange.callIsInProgress()){var B=YAHOO.util.Dom.get("current_state-"+this._dispId);var A=YAHOO.util.Dom.get("select_state-"+this._dispId);this._attachMgr.toCurrentState(B,A,this._discussionItem.state_id,this.getId(),this._attachMgr.updateDiscussionItemState,this._attachMgr);}YAHOO.util.Event.stopPropagation(C);},refreshMe:function(){var A=Ext.fly("reply_title-"+this._dispId);if(A){A.update(this._discussionItem.title);}A=Ext.fly("reply_text-"+this._dispId);if(A){A.update(this._discussionItem.content);}A=Ext.fly("reply_tags-"+this._dispId);if(A){A.update(this._getTags());}},toNoState:function(C){var B=YAHOO.util.Dom.get("current_state-"+this._dispId);var A=YAHOO.util.Dom.get("select_state-"+this._dispId);this._attachMgr.switchSelect(B,A,true);},connect:function(){Ext.fly("delete-"+this._dispId).on("click",this.deleteMe,this);Ext.fly("edit-"+this._dispId).on("click",this.editMe,this);Ext.fly("current_state-"+this._dispId).on("click",this.toStateChoice,this);Ext.fly("select_state-"+this._dispId).on("change",this.toCurrentState,this);Ext.fly("select_state-"+this._dispId).on("blur",this.toNoState,this);}};if(!core.FilterMgr){core.FilterMgr=new function(){this._filterData={};this._cachedFilterData=null;this.filterMgrApplyEvent=new YAHOO.util.CustomEvent("filterMgrApply",this);this.init=function(){this._filterData["simple"]=this._getFilterData();this._filterData["adv"]=this._getFilterData();this._filterData["all"]=this._getFilterData();this._filterData["tag"]=this._getFilterData();};this._applyfilter=function(A){this.filterMgrApplyEvent.fire();};this.applyallbtnclick=function(){if(!core.ServerExchange.callIsInProgress()){this._cachedFilterData=this._filterData["all"];this._applyfilter();}};this.applysimplebtnclick=function(){if(!core.ServerExchange.callIsInProgress()){this._getSimpleOnlyFilterData(this._filterData["simple"]);this._cachedFilterData=this._filterData["simple"];this._applyfilter();}};this.applyadvbtnclick=function(){if(!core.ServerExchange.callIsInProgress()){this._getSimpleOnlyFilterData(this._filterData["adv"]);this._getAdvOnlyFilterData(this._filterData["adv"]);this._cachedFilterData=this._filterData["adv"];this._applyfilter();}};this.applytagbtnclick=function(A){if(!core.ServerExchange.callIsInProgress()){this._cachedFilterData=this._filterData["tag"];this._cachedFilterData["tagId"]=A;this._applyfilter();}};this.getCachedFilterData=function(){return this._cachedFilterData;};this.toggleTagMode=function(A){};this._unsetCurrentTag=function(){var A=YAHOO.util.Dom.getElementsByClassName("current_tag","span","tagcloud");if(A.length>0){Ext.fly(A[0].id).removeClass("current_tag");}};this._setCurrentTag=function(A){Ext.fly(A).addClass("current_tag");};this._getSimpleOnlyFilterData=function(A){A["textfilterselect"]=Ext.ComponentMgr.get("textfilterselect").getValue();A["textsearchfor"]=Ext.ComponentMgr.get("textsearchfor").getValue();};this._getAdvOnlyFilterData=function(A){A["datefilterselect"]=Ext.ComponentMgr.get("datefilterselect").getValue();A["fromdatefield"]=coment.util.dateToString(Ext.ComponentMgr.get("fromdatefield").getValue());A["todatefield"]=coment.util.dateToString(Ext.ComponentMgr.get("todatefield").getValue());A["statefilterselect"]=Ext.ComponentMgr.get("statefilterselect").getValue();};this._getFilterData=function(){var A={};this._getSimpleOnlyFilterData(A);this._getAdvOnlyFilterData(A);A["tagId"]=-1;return A;};this.updateFormFromFilterData=function(D,A){var C=Ext.get(D);var B="";for(var E in this._cachedFilterData){B=B+'<input type="hidden" name="'+E+'" value="'+this._cachedFilterData[E]+'">';}for(var E in A){B=B+'<input type="hidden" name="'+E+'" value="'+A[E]+'">';}C.update(B);};this.submitHiddenFilterForm=function(A){document[A].submit();};};}if(!core.Language){core.Language=new function(){this._format="";this._shortformat="";this.init=function(){this._format=gettext("F j, Y, \\a\\t g:i a");this._shortformat=gettext("n/j/Y");Date.monthNames=gettext("January|February|March|April|May|June|July|August|September|October|November|December").split("|");Date.dayNames=gettext("Sunday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday").split("|");};this.formatDate=function(A){return A.dateFormat(this._format);};this.formatDateShort=function(A){return A.dateFormat(this._shortformat);};};}coment.util.alert=function(){alert("util alert");};coment.util.getAuthorAndDate=function(A){var D=(A.username=="")?gettext("anonymous"):A.username;var B=A["created"];var C=interpolate(gettext("By %(author)s on %(date)s"),{author:D,date:core.Language.formatDate(B)},true);return C;};coment.util.getTags=function(A){var B=A.tags;if(B!=""){B=gettext("tags:")+B;}return B;};coment.util.getLocation=function(){var A="[^?]*";var B=new RegExp(A);var C=B.exec(window.location.href);if(C==null){return"";}else{return C[0];}};coment.util.getPageArgs=function(){var B="";var A=window.location.href.indexOf("?");if(A!=-1){B=window.location.href.substring(A+1);}return B;};coment.util.gup=function(B){var A="[\\?&]"+B+"=([^&#]*)";var E=new RegExp(A);var D=window.location.href;var C=E.exec(D);if(C==null){return"";}else{return C[1];}};coment.util.displayYesNo=function(A,C){var B=(C)?YAHOO.util.Dom.removeClass:YAHOO.util.Dom.addClass;B.call(YAHOO.util.Dom,A,"displaynone");};coment.util.quicksort=function(B,G,D){var E=G,C=D,F;var A=B[Math.floor((G+D)/2)];do{while(B[E].val()<A.val()){E++;}while(B[C].val()>A.val()){C--;}if(E<=C){F=B[E];B[E]=B[C];B[C]=F;E++;C--;}}while(E<=C);if(G<C){coment.util.quicksort(B,G,C);}if(E<D){coment.util.quicksort(B,E,D);}};String.prototype.ellipse=function(A){if(this.length>A){return this.substr(0,A-3)+"...";}return this;};coment.util.fromMarkerIdToWord=function(A){var B=coment.cst.textWordIdPref;return parseInt(A.substr(B.length));};coment.util.fromWordToMarkerId=function(A){return coment.cst.textWordIdPref+A;};coment.util.checkLength=function(B,C,D){var A=true;if(C){A=B.length>=C;}var E=true;if(D){A=B.length<=D;}return(A&&E);};coment.util.checkNonEmpty=function(A){var B=coment.util.trim(A);return coment.util.checkLength(B,1);};coment.util.LTrim=function(B){var A=/\s*((\S+\s*)*)/;return B.replace(A,"$1");};coment.util.RTrim=function(B){var A=/((\s*\S+)*)\s*/;return B.replace(A,"$1");};coment.util.trim=function(A){return coment.util.LTrim(coment.util.RTrim(A));};coment.util.checkEmail=function(A){var B=/^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*$/;return B.test(A);};coment.util.containsSeparatorsOnly=function(B){var A=/^[\s\.\!\?;:,]*$/;return A.test(B);};coment.util.testColorFunction1=function(D){var A=12;var B=(D>A)?A:D;var E=255-Math.floor((145/A)*B);var C=E.toString(16);while(C.length<2){C="0"+C;}return"#ff"+C+"9a";};coment.util.emptyDomNode=function(A){while(A.hasChildNodes()){A.removeChild(A.firstChild);}};coment.util.setValue=function(C,B){var A=YAHOO.util.Dom.get(C);if(A){A.value=B;}};coment.util.setInnerHTML=function(C,A){var B=YAHOO.util.Dom.get(C);if(B){B.innerHTML=A;}};coment.util.getTextDocument=function(){if(coment.cst.framed){var A=this.getTextWindow();if(A){return A.document;}return null;}else{return document;}};coment.util.getTextWindow=function(){if(coment.cst.framed){return frames["frameid"];}else{return window;}};coment.util.getElt=function(C){var A=this.getTextWindow();var B=A.Ext.Element.cache[C];if(!B){B=A.Ext.Element.get(C);}return B;};coment.util.dateFromString=function(A){return Date.parseDate(A,"Y-m-d H:i:s");};coment.util.dateToString=function(A){return A.dateFormat("Y-m-d H:i:s");};if(!core.LayoutMgr){core.LayoutMgr=new function(){this.adaptDateFieldsVisibility=function(){var B=Ext.ComponentMgr.get("datefilterselect").getValue();var C=(B=="createdafter")||(B=="createdbetween");var A=(B=="createdbefore")||(B=="createdbetween");Ext.ComponentMgr.get("fromdatefield").setDisabled(!C);Ext.ComponentMgr.get("todatefield").setDisabled(!A);};this.hidemenus=function(){var A=Ext.ComponentMgr.get("fromdatefield").menu;if(A){A.hide();}A=Ext.ComponentMgr.get("todatefield").menu;if(A){A.hide();}A=Ext.ComponentMgr.get("datefilterselect").list;if(A){A.hide();}A=Ext.ComponentMgr.get("textfilterselect").list;if(A){A.hide();}};this.doLayout=function(){this.viewport.doLayout();};this.connectFilterResize=function(A){Ext.ComponentMgr.get(A).on("collapse",this.doLayout,this);Ext.ComponentMgr.get(A).on("expand",this.doLayout,this);Ext.ComponentMgr.get(A).on("hide",this.doLayout,this);Ext.ComponentMgr.get(A).on("show",this.doLayout,this);};this.init=function(){this.globalLayoutInit();Ext.get("simplefilter_apply_btn").on("click",core.FilterMgr.applysimplebtnclick,core.FilterMgr);Ext.get("advfilter_apply_btn").on("click",core.FilterMgr.applyadvbtnclick,core.FilterMgr);Ext.get("simplefilter_view_comments").on("click",core.FilterMgr.applyallbtnclick,core.FilterMgr);Ext.get("advfilter_view_comments").on("click",core.FilterMgr.applyallbtnclick,core.FilterMgr);Ext.get("tagcloud_view_comments").on("click",core.FilterMgr.applyallbtnclick,core.FilterMgr);Ext.get("view_all_comments").on("click",core.FilterMgr.applyallbtnclick,core.FilterMgr,{"preventDefault":true,"stopPropagation":true});Ext.get("mail_sub").on("click",core.TextMgr.onMailSubscribe,core.TextMgr,{"preventDefault":true,"stopPropagation":true});Ext.ComponentMgr.get("datefilterselect").on("select",this.adaptDateFieldsVisibility,this,true);this.infoMsgElt=Ext.get("info_msg");this.errorMsgElt=Ext.get("error_msg");var A=Ext.get("addattach");if(A){A.setVisible(true);}A=Ext.get("editattach");if(A){A.setVisible(true);}this.activateAttachListTab();this.hideEditAttachTab();var A=YAHOO.util.Dom.get("current_sel");this._initialSelectionContent=(A)?A.innerHTML:null;this.doLayout();this.connectFilterResize("datefieldset");this.connectFilterResize("textfieldset");this.connectFilterResize("statefieldset");this.updateMailLnk();};this.globalLayoutInit=function(){var P=new Ext.Panel({title:gettext("List"),id:"attachsPanel"});this.attachsTabPanel=new Ext.TabPanel({region:"north",height:250,border:false,split:true,activeTab:0,defaults:{autoScroll:true},items:[P]});if(null!=YAHOO.util.Dom.get("editattach")){new Ext.Button({id:"edit_btn",renderTo:"edit_",text:gettext("save changes")});new Ext.Button({id:"edit_cancel_btn",renderTo:"edit_cancel",text:gettext("cancel")});var C=new Ext.Panel({contentEl:"editattach",title:gettext("Edit"),id:"editAttachPanel"});this.attachsTabPanel.add(C);}if(null!=YAHOO.util.Dom.get("addattach")){new Ext.Button({id:"add_btn",renderTo:"add_",text:gettext("add comment")});var H=new Ext.Panel({contentEl:"addattach",title:gettext("Add"),id:"addAttachPanel"});this.attachsTabPanel.add(H);coment.util.setValue("add_author",core.User.getCookieAuthor());coment.util.setValue("add_email",core.User.getCookieEMail());}var G=new Ext.data.SimpleStore({fields:["datesearchtypeid","datesearchtype"],data:[["createdbefore",gettext("before")],["createdafter",gettext("after")],["createdbetween",gettext("between")],["",gettext("no date criteria")]]});var O=new Ext.data.SimpleStore({fields:["textsearchtypeid","textsearchtype"],data:[["text_and_title",gettext("comments' text and title")],["user",gettext("comments' authors")]]});var M=new Ext.ux.Multiselect({id:"statefilterselect",name:"statefilterselect",fieldLabel:gettext("States"),dataFields:["stateid","statename"],data:core.TextMgr.getWorkflowStates(),valueField:"stateid",displayField:"statename",width:150,height:60,allowBlank:true});var J=new Ext.form.ComboBox({id:"datefilterselect",valueField:"datesearchtypeid",store:G,displayField:"datesearchtype",typeAhead:true,mode:"local",triggerAction:"all",emptyText:gettext("Choose..."),labelSeparator:"",editable:false,width:180});var L=new Ext.form.ComboBox({id:"textfilterselect",valueField:"textsearchtypeid",store:O,displayField:"textsearchtype",typeAhead:true,mode:"local",triggerAction:"all",hideLabel:true,editable:false,width:230});var B=new Ext.form.DateField({id:"fromdatefield",format:gettext("m/d/Y"),cancelText:gettext("cancel"),fieldLabel:gettext("From"),name:"fromDate",disabled:true});var K=new Ext.form.DateField({id:"todatefield",format:gettext("m/d/Y"),fieldLabel:gettext("To"),name:"toDate",disabled:true});var I=new Ext.Panel({id:"tagcloud",title:"",bodyStyle:"background-color:#EBEBEB;padding:5px;margin:10px;text-align:center;	border:1px solid #D0D0D0;",html:"tag cloud goes here"});var D=new Ext.Panel({id:"tagcloudreset",layout:"column",border:false,title:"",items:[{columnWidth:0.4,html:"&nbsp;",border:false},{columnWidth:0.2,layout:"form",border:false,items:[{xtype:"button",id:"tagcloud_view_comments",text:gettext("All comments")}]},{columnWidth:0.4,html:"&nbsp;",border:false}]});var A=new Ext.FormPanel({id:"filterform",frame:false,title:"",bodyStyle:'padding:5px 5px 0", //;border:none;',items:[{xtype:"fieldset",id:"textfieldset",title:gettext("Text"),collapsible:false,autoHeight:true,items:[{layout:"table",border:false,items:[{html:gettext("Search")+"&nbsp;",border:false},{xtype:"textfield",name:"home1",id:"textsearchfor",hideLabel:true,width:170},{html:"&nbsp;"+gettext("in")+"&nbsp;",border:false},L,{xtype:"button",id:"simplefilter_apply_btn",text:gettext("Apply Filter")},{html:"&nbsp;",border:false},{xtype:"button",id:"simplefilter_view_comments",text:gettext("All comments")}]}]},{xtype:"fieldset",id:"datefieldset",title:gettext("Date"),collapsible:false,autoHeight:true,layout:"column",border:true,items:[{columnWidth:0.34,layout:"form",border:false,labelWidth:10,items:[J]},{columnWidth:0.33,layout:"form",border:false,items:[B]},{columnWidth:0.33,layout:"form",border:false,items:[K]}]},{xtype:"fieldset",id:"statefieldset",title:gettext("States"),collapsible:false,autoHeight:true,layout:"column",border:true,items:[{columnWidth:0.25,layout:"form",border:false,html:"&nbsp;"},{columnWidth:0.5,layout:"form",border:false,items:[M]},{columnWidth:0.25,layout:"form",border:false,html:"&nbsp;"}]},{id:"adv_btn_section",layout:"column",border:false,items:[{columnWidth:0.35,html:"&nbsp;",border:false},{columnWidth:0.4,layout:"table",layoutConfig:{columns:3},border:false,items:[{xtype:"button",id:"advfilter_apply_btn",text:gettext("Apply Filter")},{html:"&nbsp;",border:false},{xtype:"button",id:"advfilter_view_comments",text:gettext("All comments")}]},{columnWidth:0.25,html:"&nbsp;",border:false}]}]});var F=true;var Q=360;var N="auto";var E=false;if(sv_embeded){N=0;Q=250;F=false;E=true;}this.viewport=new Ext.Viewport({layout:"border",border:false,items:[new Ext.BoxComponent({region:"north",border:false,el:"client_header",margins:"0 0 0 0",height:22}),{layout:"border",region:"center",listeners:this.LinkInterceptor,border:false,items:[{id:"filter_top",region:"north",height:N,autoHeight:F,margins:"0 0 0 0",layout:"column",items:[{id:"filter_left_col",columnWidth:0.5},{width:800,border:false,items:[I,A,D]},{id:"filter_right_col",columnWidth:0.5}]},{title:gettext("Comments")+'&nbsp;&nbsp;<a id="view_all_comments" href="#">'+gettext("View all")+'</a>&nbsp;&nbsp;<a id="mail_sub" href="#" title=""></a>',id:"attachsregion",border:false,collapsible:true,floatable:false,collapsed:E,region:"west",split:true,margins:"0 0 0 0",width:Q,minSize:100,maxSize:500,layout:"fit",items:[this.attachsTabPanel]},{id:"text_frame",region:"center",border:false,margins:"0 0 0 0",layout:"fit",contentEl:"frameContainer"}]}]});Ext.ComponentMgr.get("fromdatefield").setValue(new Date("1/1/2007"));Ext.ComponentMgr.get("todatefield").setValue(new Date("1/1/2100"));M.setValue(core.TextMgr.getWorkflowStateValues());L.setValue("text_and_title");this.showNoFilter();};this.activateAttachListTab=function(){core.LayoutMgr.attachsTabPanel.setActiveTab("attachsPanel");};this.activateAddAttachTab=function(){core.LayoutMgr.attachsTabPanel.setActiveTab("addAttachPanel");};this.hideEditAttachTab=function(){if(Ext.ComponentMgr.get("editAttachPanel")){this.attachsTabPanel.hideTabStripItem("editAttachPanel");Ext.ComponentMgr.get("editAttachPanel").hide();this.activateAttachListTab();}};this.unhideEditAttachTab=function(){if(Ext.ComponentMgr.get("editAttachPanel")){this.attachsTabPanel.unhideTabStripItem("editAttachPanel");Ext.ComponentMgr.get("editAttachPanel").show();this.activateEditAttachTab();}};this.activateEditAttachTab=function(){core.LayoutMgr.attachsTabPanel.setActiveTab("editAttachPanel");};this.updatePanelTitle=function(C,B){var A=Ext.ComponentMgr.get(C);if(A){if(A){A.setTitle(B);}}};this.changeButtonHandler=function(A,D,C){var E=A+"_btn";var B=Ext.ComponentMgr.get(E);if(B){B.setHandler(D,C);}};this.displayInfoMsg=function(A){if(this.opt){if(this.opt.anim.isAnimated()){this.opt.anim.stop();}}else{this.opt={duration:6,method:"easeInSTrong",scope:this};}this.infoMsgElt.setStyle({"background-color":"#3BE620"});this.infoMsgElt.update(A);this.infoMsgElt.setVisible(true);this.infoMsgElt.setVisible(false,this.opt);};this.displayErrorMsg=function(A){if(this.erroropt){if(this.erroropt.anim.isAnimated()){this.erroropt.anim.stop();}}else{this.erroropt={duration:6,method:"easeInSTrong",scope:this};}this.errorMsgElt.setStyle({"background-color":"#F00"});this.errorMsgElt.update(A);this.errorMsgElt.setVisible(true);this.errorMsgElt.setVisible(false,this.erroropt);};this.showNoFilter=function(A){this.showSimpleOrAdvanceFilter(true);Ext.ComponentMgr.get("textfieldset").setVisible(false);this.doLayout();};this.showSimpleFilter=function(){this.showSimpleOrAdvanceFilter(true);this.doLayout();};this.showAdvanceFilter=function(){this.showSimpleOrAdvanceFilter(false);this.doLayout();};this.showTagCloudFilter=function(){this.showTagCloudOrFilter(true);Ext.ComponentMgr.get("textfieldset").setVisible(false);this.doLayout();};this.showTagCloudOrFilter=function(A){Ext.ComponentMgr.get("filterform").setVisible(!A);Ext.ComponentMgr.get("tagcloud").setVisible(A);Ext.ComponentMgr.get("tagcloudreset").setVisible(A);};this.showSimpleOrAdvanceFilter=function(A){this.showTagCloudOrFilter(false);Ext.ComponentMgr.get("textfieldset").setVisible(true);Ext.ComponentMgr.get("simplefilter_apply_btn").setVisible(A);Ext.ComponentMgr.get("simplefilter_view_comments").setVisible(A);Ext.ComponentMgr.get("adv_btn_section").setVisible(!A);Ext.ComponentMgr.get("datefieldset").setVisible(!A);if(sv_manageComPerm){Ext.ComponentMgr.get("statefieldset").setVisible(!A);}else{Ext.ComponentMgr.get("statefieldset").setVisible(false);}};this.getInitialSelectionContent=function(){return this._initialSelectionContent;};this.updateMailLnk=function(){if(sv_loggedIn){var C=(!sv_mailsub)?gettext("Subscribe"):gettext("Unsubscribe");var A=(!sv_mailsub)?gettext("Click to receive email notifications when this text is changed or when a comment is added"):gettext("Click to unsubscribe from email notifications");var B=Ext.get("mail_sub");B.update(C);B.set({"title":A});}};this.LinkInterceptor={render:function(A){A.body.on({"mousedown":function(C,B){B.target="_blank";},"click":function(C,B){if(String(B.target).toLowerCase()!="_blank"){C.stopEvent();window.open(B.href);}},delegate:"a"});}};};}if(!core.MenuMgr){core.MenuMgr=new function(){this.init=function(){util.setInnerHTML("viewItemBar",gettext("View"));util.setInnerHTML("viewFilter",gettext("Filter"));util.setInnerHTML("viewFilterNone",gettext("None"));util.setInnerHTML("viewFilterSimple",gettext("Simple"));util.setInnerHTML("viewFilterAdvanced",gettext("Advanced"));util.setInnerHTML("viewFilterTags",gettext("Tag cloud"));util.setInnerHTML("actionItemBar",gettext("Actions"));util.setInnerHTML("editAction",gettext("Edit"));util.setInnerHTML("sharingAction",gettext("Sharing and moderation"));util.setInnerHTML("embedAction",gettext("Embed"));util.setInnerHTML("feedsAction",gettext("Feeds"));util.setInnerHTML("printAction",gettext("Print"));util.setInnerHTML("printActionTextAndCommentsItem",gettext("Text with (filtered) comments"));util.setInnerHTML("printActionTextOnlyItem",gettext("Text only"));util.setInnerHTML("printActionTextOnlyAsPdf",gettext("As Portable Document Format"));util.setInnerHTML("printActionTextOnlyFromBrow",gettext("From Browser"));util.setInnerHTML("printActionTextAndCommentsAsPdf",gettext("As Portable Document Format"));util.setInnerHTML("printActionTextAndCommentsFromBrow",gettext("From Browser"));util.setInnerHTML("advancedAction",gettext("Advanced"));util.setInnerHTML("advancedActionApplyAmendments",gettext("Apply amendments"));util.setInnerHTML("exportAction",gettext("Export"));util.setInnerHTML("exportActionTextAndComments",gettext("Text with (filtered) comments"));util.setInnerHTML("exportActionTextOnly",gettext("Text only"));util.setInnerHTML("exportActionTextOnlyAsPdf",gettext("As Portable Document Format"));util.setInnerHTML("exportActionTextOnlyAsRtf",gettext("As Rich Text Format"));util.setInnerHTML("exportActionTextOnlyAsOdt",gettext("As Open Document Text"));util.setInnerHTML("exportActionTextOnlyAsDoc",gettext("As Microsoft Word 97/2000/XP"));util.setInnerHTML("exportActionTextOnlyAsTxt",gettext("As Text Format"));util.setInnerHTML("exportActionTextAndCommentsAsPdf",gettext("As Portable Document Format"));util.setInnerHTML("exportActionTextAndCommentsAsRtf",gettext("As Rich Text Format"));util.setInnerHTML("exportActionTextAndCommentsAsOdt",gettext("As Open Document Text"));util.setInnerHTML("exportActionTextAndCommentsAsDoc",gettext("As Microsoft Word 97/2000/XP"));util.setInnerHTML("exportActionTextAndCommentsAsTxt",gettext("As Text Format"));var F=new YAHOO.widget.MenuBar("menudiv");var J=YAHOO.widget.MenuManager.getMenu("viewFilterSubMenu");this.viewFilterNoneItem=J.getItem(0);this.viewFilterSimpleItem=J.getItem(1);this.viewFilterAdvancedItem=J.getItem(2);this.viewFilterTagCloudItem=J.getItem(3);onViewFilterNoneClick=function(L,K,M){core.LayoutMgr.showNoFilter();this.parent.hide();core.MenuMgr.checkCurrentFilterView(0);};onViewFilterSimpleClick=function(L,K,M){core.LayoutMgr.showSimpleFilter();this.parent.hide();core.MenuMgr.checkCurrentFilterView(1);};onViewFilterAdvancedClick=function(L,K,M){core.LayoutMgr.showAdvanceFilter();this.parent.hide();core.MenuMgr.checkCurrentFilterView(2);};onViewFilterTagCloudClick=function(L,K,M){core.LayoutMgr.showTagCloudFilter();this.parent.hide();core.MenuMgr.checkCurrentFilterView(3);};this.checkCurrentFilterView=function(K){core.MenuMgr.viewFilterNoneItem.cfg.setProperty("checked",(K==0));core.MenuMgr.viewFilterSimpleItem.cfg.setProperty("checked",(K==1));core.MenuMgr.viewFilterAdvancedItem.cfg.setProperty("checked",(K==2));core.MenuMgr.viewFilterTagCloudItem.cfg.setProperty("checked",(K==3));};this.viewFilterNoneItem.cfg.setProperty("onclick",{fn:onViewFilterNoneClick,scope:this.viewFilterNoneItem});this.viewFilterSimpleItem.cfg.setProperty("onclick",{fn:onViewFilterSimpleClick,scope:this.viewFilterSimpleItem});this.viewFilterAdvancedItem.cfg.setProperty("onclick",{fn:onViewFilterAdvancedClick,scope:this.viewFilterAdvancedItem});this.viewFilterTagCloudItem.cfg.setProperty("onclick",{fn:onViewFilterTagCloudClick,scope:this.viewFilterTagCloudItem});this.viewAllCommentsAction=YAHOO.widget.MenuManager.getMenuItem("viewAllCommentsAction");this.viewAllCommentsAction.cfg.setProperty("onclick",{fn:core.FilterMgr.applyallbtnclick,scope:core.FilterMgr});this.viewVersionsSubMenu=YAHOO.widget.MenuManager.getMenu("viewVersionsSubMenu");this.checkCurrentVersion=function(L){var M=0;var K=null;while(K=this.viewVersionsSubMenu.getItem(M++)){if(K.element.id=="verm_"+sv_versionId){K.cfg.setProperty("checked",true);}}};var D=YAHOO.widget.MenuManager.getMenu("printActionTextOnlySubMenu");this.printTextOnlyAsPdf=D.getItem(0);var A=D.getItem(1);var C=YAHOO.widget.MenuManager.getMenu("printActionTextAndCommentsSubMenu");this.printTextAndCommentsAsPdf=C.getItem(0);var G=C.getItem(1);onPrintTextAndCommentsFromBrowClick=function(K,L){core.PrintMgr.onPrintTextAndCommentsClick();};G.clickEvent.subscribe(onPrintTextAndCommentsFromBrowClick);onPrintTextOnlyFromBrowClick=function(K,L){core.PrintMgr.onPrintTextOnlyItemClick();};A.clickEvent.subscribe(onPrintTextOnlyFromBrowClick);var B=YAHOO.widget.MenuManager.getMenu("advancedActionSubMenu");if(B){var I=B.getItem(0);onEditVersionApplyAmendmentsClick=function(K,L){core.TextMgr.applyAmendments();};I.clickEvent.subscribe(onEditVersionApplyAmendmentsClick);}var E=YAHOO.widget.MenuManager.getMenu("exportActionTextOnlySubMenu");this.exportTextOnlyAsPdf=E.getItem(0);this.exportTextOnlyAsRtf=E.getItem(1);this.exportTextOnlyAsOdt=E.getItem(2);this.exportTextOnlyAsDoc=E.getItem(3);this.exportTextOnlyAsTxt=E.getItem(4);onExportTextOnlyAs=function(L,K,M){core.ExportMgr.onExportTextOnlyClick(M);};this.exportTextOnlyAsPdf.cfg.setProperty("onclick",{fn:onExportTextOnlyAs,obj:"pdf"});this.printTextOnlyAsPdf.cfg.setProperty("onclick",{fn:onExportTextOnlyAs,obj:"pdf"});this.exportTextOnlyAsRtf.cfg.setProperty("onclick",{fn:onExportTextOnlyAs,obj:"rtf"});this.exportTextOnlyAsOdt.cfg.setProperty("onclick",{fn:onExportTextOnlyAs,obj:"odt"});this.exportTextOnlyAsDoc.cfg.setProperty("onclick",{fn:onExportTextOnlyAs,obj:"doc"});this.exportTextOnlyAsTxt.cfg.setProperty("onclick",{fn:onExportTextOnlyAs,obj:"text"});var H=YAHOO.widget.MenuManager.getMenu("exportActionTextAndCommentsSubMenu");this.exportTextAndCommentsAsPdf=H.getItem(0);this.exportTextAndCommentsAsRtf=H.getItem(1);this.exportTextAndCommentsAsOdt=H.getItem(2);this.exportTextAndCommentsAsDoc=H.getItem(3);this.exportTextAndCommentsAsTxt=H.getItem(4);onExportTextAndCommentsAs=function(L,K,M){core.ExportMgr.onExportTextAndCommentsClick(M);};this.exportTextAndCommentsAsPdf.cfg.setProperty("onclick",{fn:onExportTextAndCommentsAs,obj:"pdf"});this.printTextAndCommentsAsPdf.cfg.setProperty("onclick",{fn:onExportTextAndCommentsAs,obj:"pdf"});this.exportTextAndCommentsAsRtf.cfg.setProperty("onclick",{fn:onExportTextAndCommentsAs,obj:"rtf"});this.exportTextAndCommentsAsOdt.cfg.setProperty("onclick",{fn:onExportTextAndCommentsAs,obj:"odt"});this.exportTextAndCommentsAsDoc.cfg.setProperty("onclick",{fn:onExportTextAndCommentsAs,obj:"doc"});this.exportTextAndCommentsAsTxt.cfg.setProperty("onclick",{fn:onExportTextAndCommentsAs,obj:"text"});this.checkCurrentFilterView(0);this.checkCurrentVersion();F.render();};};}if(!core.TextMgr){core.TextMgr=new function(){this._attachMgr=null;this._comment_workflow_states=sv_comment_workflow_states;if(!coment.cst.framed){YAHOO.util.Event.addListener(coment.cst.textNodeId,"click",this.textClick,this,true);}this.register=function(A){this._attachMgr=A;var B=Ext.get("add_btn");if(B){B.on("click",A.addAttachButtonClick,A);}B=Ext.get("edit_btn");if(B){B.on("click",A.editAttachButtonClick,A);}B=Ext.get("edit_cancel_btn");if(B){B.on("click",A.editCancelAttachButtonClick,A);}B=Ext.get("edit_modif_scope");if(B){B.on("click",A.editAttachModifScopeClick,A);}Ext.ComponentMgr.get("tagcloud").body.on("click",A.tagclicked,A);};this.onFilterMgrApply=function(B,A,C){C._attachMgr.renderOccurences();C._attachMgr.populateTagCloud();core.LayoutMgr.activateAttachListTab();};this.textClick=function(A){if(!core.ServerExchange.callIsInProgress()){var B=YAHOO.util.Event.getTarget(A);this._attachMgr.occClick(B.id,A);}};this.applyAmendments=function(){if(!core.ServerExchange.callIsInProgress()){var A=core.ServerExchange.send("applyAmendments",{},this._applyAmendmentsReturns,this,"",gettext("amendments could not be added"));}};this._applyAmendmentsReturns=function(A){core.LayoutMgr.displayInfoMsg(A["success_message"]);window.location.href=A["location"];};this.downOnFrame=function(A){core.LayoutMgr.hidemenus();};this.getStateOptions=function(){var B="";for(var A in this._comment_workflow_states){B=B+'<option value="'+A+'">'+this._comment_workflow_states[A]+"</option>";}return B;};this.getWorkflowStates=function(){var B=[];for(var A in this._comment_workflow_states){B[B.length]=[A,this._comment_workflow_states[A]];}return B;};this.getWorkflowStateValues=function(){var B=[];for(var A in this._comment_workflow_states){B[B.length]=A;}return B;};this.getStateName=function(A){return this._comment_workflow_states[A];};this.onMailSubscribe=function(){var B=(sv_mailsub)?"0":"1";if(!core.ServerExchange.callIsInProgress()){var A=core.ServerExchange.send("mailSubscribe",{"mailsub":B},this._mailSubscribeReturns,this,"",gettext("could not subscribe"));}};this._mailSubscribeReturns=function(A){core.LayoutMgr.displayInfoMsg(A["success_message"]);sv_mailsub=A["new_sub"];core.LayoutMgr.updateMailLnk();};};}if(!core.PrintMgr){core.PrintMgr=new function(){this.onPrintTextAndCommentsClick=function(){this._printIt(0);},this.onPrintTextOnlyItemClick=function(){this._printIt(1);},this._printIt=function(A){core.FilterMgr.updateFormFromFilterData("printFilterHiddenForm",{"txtOnly":A,"versionId":sv_versionId,"versionId":sv_versionId});core.FilterMgr.submitHiddenFilterForm("printFilterHiddenForm");};};}if(!core.ExportMgr){core.ExportMgr=new function(){this.onExportTextAndCommentsClick=function(A){this._export(0,A);},this.onExportTextOnlyClick=function(A){this._export(1,A);},this._export=function(A,B){core.FilterMgr.updateFormFromFilterData("exportFilterHiddenForm",{"txtOnly":A,"format":B});core.FilterMgr.submitHiddenFilterForm("exportFilterHiddenForm");};};}if(!core.So_Computation){core.So_Computation=new function(){this.so_computeOccs=function(A){var F=0;for(var C=0;C<A.length;C++){if(F<A[C].end_word){F=A[C].end_word;}}F=F+2;var E=[];for(var D=0;D<F;D++){E.push(0);}for(var C=0;C<A.length;C++){for(var H=A[C].start_word;H<=A[C].end_word;H++){E[H]=E[H]+1;}}var B=[];var I=-1;var D=0;for(D=0;D<E.length;D++){if(E[D]!=I){if(B.length>0){B[B.length-1]["endWord"]=D-1;}B.push({"endWord":-1,"startWord":D,"nbWord":E[D]});I=E[D];}}if(B.length>0){B[B.length-1]["endWord"]=D-1;}var G=[];for(var C=0;C<B.length;C++){if(B[C]["nbWord"]!=0){G.push(B[C]);}}return G;},this.so_filter=function(A,I,H,J){var K=[];for(var P=0;P<I.length;P++){K.push(I[P]);}var C=[];for(var S in H){for(var P=0;P<H[S].length;P++){C.push(H[S][P]);}}var N=A["tagId"];if(N!=-1){var D="";for(var P=0;P<J.length;P++){if(J[P].id==N){D=J[P].name;break;}}K=this.so_filterOnTag(D,K);C=this.so_filterOnTag(D,C);}else{var M=A["textfilterselect"];var E=A["textsearchfor"];var Q=A["datefilterselect"];var L=coment.util.dateFromString(A["fromdatefield"]);var R=coment.util.dateFromString(A["todatefield"]);var F=A["statefilterselect"];E=E.trim();K=this.so_filterOnTextSearchedFor(M,E,K);K=this.so_filterOnDate(Q,L,R,K);K=this.so_filterOnState(F,K);C=this.so_filterOnTextSearchedFor(M,E,C);C=this.so_filterOnDate(Q,L,R,C);C=this.so_filterOnState(F,C);}for(var P=0;P<C.length;P++){for(var O=0;O<I.length;O++){if(C[P].comment_id==I[O].id){K.push(I[O]);}}}var B=new Array();var G=new Array();for(var P=0;P<K.length;P++){if(!B.contains(K[P].id)){B.push(K[P].id);G.push(K[P]);}}return G;},this.so_filterOnTag=function(C,F){var E=[];var D=new RegExp(","+C+",","gi");for(var B=0;B<F.length;B++){var A=","+F[B].tags+",";if(D.exec(A)!=null){E.push(F[B]);}}return E;},this.so_filterOnTextSearchedFor=function(G,B,E){var A=[];var I=new RegExp(B,"gi");for(var D=0;D<E.length;D++){switch(G){case"text_and_title":var F=E[D].content;var H=E[D].title;if(I.exec(F)!=null||I.exec(H)!=null){A.push(E[D]);}break;case"user":var C=E[D].username;if(I.exec(C)){A.push(E[D]);}break;}}return A;},this.so_filterOnDate=function(B,D,A,H){var E=[];for(var C=0;C<H.length;C++){var G=coment.util.dateFromString(H[C].created);var F=((B=="createdbetween")&&(G>=D)&&(G<=A));F=F||((B=="createdafter")&&(G>=D));F=F||((B=="createdbefore")&&(G<=A));F=F||(B=="");if(F){E.push(H[C]);}}return E;},this.so_filterOnState=function(A,F){var C=Ext.util.JSON.decode("["+A+"]");var E=[];for(var B=0;B<F.length;B++){var D=F[B].state_id;if(C.contains(D)){E.push(F[B]);}}return E;};};}if(!core.SelectionMgr){core.SelectionMgr=new function(){this._fromWord=null;this._toWord=null;this._lastSelection="";this.cachedSelectedColors={};this.clearSelection=function(){if(YAHOO.util.Event.isIE){var C=coment.util.getTextDocument();C.selection.empty();}else{var B=coment.util.getTextWindow();var A=B.getSelection();if(A){A.removeAllRanges();}}};this.init=function(){if(coment.cst.framed){YAHOO.util.Event.addListener(document,"mouseup",this.onRetrieveSelection,this,true);}else{YAHOO.util.Event.addListener(window,"keyup",this.onRetrieveSelection,this,true);var A=YAHOO.util.Dom.get(coment.cst.textNodeId).parentNode.parentNode;YAHOO.util.Event.addListener(A,"mouseup",this.onRetrieveSelection,this,true);}};this._getSelection=function(){var X=[];var L="";var I=coment.cst.maxSelectedTxtLength;var G=interpolate(gettext("Selected text is too long (selection is limited to %(count)s characters). \nPlease retry."),{count:I},true);var Y=coment.util.getTextDocument();var E=coment.util.getTextWindow();if(YAHOO.util.Event.isIE){var P=Y.selection.createRange();var S=P.text;if((S.length>0)){if(S.length>I){alert(G);}else{var R=P.htmlText;var H=new RegExp("id="+coment.cst.textWordIdPref,"i");if(!H.test(R)){var V=coment.util.fromMarkerIdToWord(P.parentElement().id);X=[V,V];}else{var A=R.split(H);var D=1;if(A.length>1){var K=A[1].indexOf(">");var J=A[1].lastIndexOf("</");var C=A[1].substring(K+1,J);var U=Y.getElementById(coment.util.fromWordToMarkerId(parseInt(A[1]))).innerHTML;if((C!=U)&&coment.util.containsSeparatorsOnly(C)){D=2;}}for(var T=D;T<A.length;T++){var Q=parseInt(A[T]);if(Q>-1){X.push(Q);break;}}for(var T=A.length-1;T>D-1;T--){var Q=parseInt(A[T]);if(Q>-1){X.push(Q);break;}}}}}}else{var R=null;if(E.getSelection){R=E.getSelection();}else{if(Y.selection){R=Y.selection.createRange();}}if(R){var S=R.toString();if(S.length>0){if(S.length>I){alert(G);}else{var N=R.getRangeAt(0);var B=N.startContainer;var F=N.endContainer;var W=B.parentNode;var O=F.parentNode;if(W.tagName.toUpperCase()=="SPAN"&&W.id&&(W.id.indexOf("w_")==0)&&O.tagName.toUpperCase()=="SPAN"&&O.id&&(O.id.indexOf("w_")==0)){X=[coment.util.fromMarkerIdToWord(W.id),coment.util.fromMarkerIdToWord(O.id)];var M=coment.util.fromMarkerIdToWord(W.id);var P=Y.createRange();P.selectNode(Y.getElementById(W.id));P.setStart(N.startContainer,N.startOffset);if(P.toString()==""){X[0]=X[0]+1;}P.detach();var P=Y.createRange();P.selectNode(Y.getElementById(O.id));P.setEnd(N.endContainer,N.endOffset);if(P.toString()==""&&X[1]>X[0]){X[1]=X[1]-1;}P.detach();}}}}}for(var T=X[0];T<X[1]+1;T++){L=L+Y.getElementById(coment.util.fromWordToMarkerId(T)).innerHTML;}return[X,L];};this._previewSelectionInAddAttachPanel=function(G){var A=coment.cst.currentSelDispLength;var I=G.length;var H=YAHOO.util.Dom.get("current_sel");var F=YAHOO.util.Dom.get("edit_current_sel");if(I<=A){H.innerHTML=G;if(F){F.innerHTML=G;}}else{var J="[...]";var C=(A-J.length)/2;var E=G.substring(0,C);var B=E.lastIndexOf(" ");if(B!=-1&&B<C-1){E=E.substring(0,B+1);}var D=G.substring(G.length-C);var B=D.indexOf(" ");if(B!=-1&&B>0){D=D.substring(B);}H.innerHTML=E+J+D;if(F){F.innerHTML=E+J+D;}}};this.getSelectionFromWord=function(){return this._fromWord;};this.getSelectionToWord=function(){return this._toWord;};this.onRetrieveSelection=function(B){if(sv_addComPerm){var A=this._getSelection();if(A[0].length==2){this._fromWord=A[0][0];this._toWord=A[0][1];this._previewSelectionInAddAttachPanel(A[1]);}}};};}commentListItemSelector="div.coment_comment";_paneltpl=new Ext.DomHelper.Template('<div id="{id}" class="disp_comment"><span id="delete-{id}" class="comment_btn comment_delete yunselectable {vis_remclass}" title="{delete_comment_tooltip}"><pre>   </pre></span><span id="edit-{id}" class="comment_btn comment_edit yunselectable {vis_remclass}" title="{edit_comment_tooltip}"><pre>   </pre></span><select id="select_state-{id}" class="displaynone comment_wfstate_select comment_btn">{select_options}</select><span id="current_state-{id}" class="comment_wfstate comment_btn {vis_manclass}" title="{change_wfstate_tooltip}">{current_state}</span><div  id="comment_title-{id}" class="comment_title_cls">{title}</div><div class="comment_authordate_cls">{authordate}</div><div id="excerpt-{id}" class="comment_text_cls">{excerpt_text}</div><div id="text-{id}" class="displaynone comment_text_cls">{text}</div><div id="comment_tags-{id}" class="comment_tags_cls yunselectable">{comment_tags}</div><div id="comment_nbreplies-{id}" class="comment_nbreplies yunselectable">{nbreplies}</div><span id="read-{id}" class="{vis_readbtnclass} comment_readreply yunselectable">{read}</span><span id="discs-{id}"></span><span id="minimize-{id}" class="comment_readreply yunselectable displaynone">{minimize}</span><span id="reply-{id}" class="{vis_replybtnclass} comment_readreply yunselectable">{reply}</span><div id="replyform-{id}" class="displaynone discussattach yunselectable"></div></div>');_paneltpl.compile();_replyformtpl=new Ext.DomHelper.Template('<div id="add_attach_user-{id}" class="displaynone"><label>{authornamelabel}</label><input type="text" size="22" id="discuss_author-{id}" name="author" value="{cook_name}" class="textinput"></input><div class="field_error displaynone" id="error_discuss_author-{id}"></div><label>{authoremaillabel}</label><input type="text" size="22" id="discuss_email-{id}" name="email" value="{cook_email}" class="textinput"></input><div class="field_error displaynone" id="error_discuss_email-{id}"></div></div><label>{replytitlelabel}<span class="requir">*</span></label><input type="text" size="22" id="discuss_comment_title-{id}" class="textinput" value="{replytitle}"></input><div id="error_discuss_comment_title-{id}" class="field_error displaynone"></div><label>{replytextlabel}<span class="requir">*</span></label><textarea rows="10" cols="40" id="discuss_comment_text-{id}" type="text" class="textinput"></textarea><div id="error_discuss_comment_text-{id}" class="field_error displaynone"></div><label >{tagslabel}</label><input type="text" class="textinput" id="discuss_comment_tags-{id}" size="22"></input><div class="field_error displaynone" id="error_discuss_comment_tags-{id}"></div><table><tr><td><div id="applyreply-{id}"></div></td><td><div id="cancelreply-{id}"></div></td></tr></table>');_replyformtpl.compile();core.Attach=function(B,A){this.attach=B;this._listid="comment-"+this.attach.id;this._panelid="panel-comment-"+this.attach.id;this._attachMgr=A;};core.Attach.prototype={getId:function(){return this.attach.id;},getPanelId:function(){return this._panelid;},getListId:function(){return this._listid;},getStartWord:function(){return this.attach.start_word;},getEndWord:function(){return this.attach.end_word;},setAttach:function(A){this.attach=A;},computeNbRepliesMsg:function(){ret="";if(this.attach.discussion_count&&this.attach.discussion_count>0){if(this.attach.discussion_count<=1){ret=interpolate(gettext("%(count)s reply"),{count:this.attach.discussion_count},true);}else{ret=interpolate(gettext("%(count)s replies"),{count:this.attach.discussion_count},true);}}return ret;},_getExcerpt:function(){return Ext.util.Format.stripTags(this.attach.content).ellipse(90);},_getTags:function(){return coment.util.getTags(this.attach);},couldBeEdited:function(B){var A=false;if(sv_remComPerm){A=true;}else{if(sv_loggedIn&&this.attach["username"]==sv_username&&this.attach.state_id==sv_wrkf_initialstateid){A=(this.attach.discussion_count==0);}}return A;},toListItemPanel:function(){var F=this.computeNbRepliesMsg();var C=this._getExcerpt();var H=coment.util.getAuthorAndDate(this.attach);var I=(this.couldBeEdited(true))?"":"displaynone";var B=(sv_so_b||sv_manageComPerm)?"":"displaynone";var E=((C.length!=this.attach.content.length)||(this.attach.discussion_count>0))?"":"displaynone";var D=(sv_so_b)?"displaynone":"";var J=this._getTags();var A=_paneltpl.applyTemplate({id:this._listid,authordate:H,title:this.attach.title,excerpt_text:C,comment_tags:J,text:this.attach.content,delete_comment_tooltip:gettext("delete comment"),edit_comment_tooltip:gettext("edit comment"),vis_remclass:I,vis_manclass:B,change_wfstate_tooltip:gettext("click to change"),select_options:core.TextMgr.getStateOptions(),nbreplies:F,read:gettext("Read"),vis_readbtnclass:E,vis_replybtnclass:D,reply:gettext("Reply"),minimize:gettext("Minimize"),current_state:core.TextMgr.getStateName(this.attach.state_id)});var G=new Ext.Panel({id:this.getPanelId(),items:[{border:false,html:A}]});return G;},refreshDiscussionItemCount:function(){var A=Ext.fly("comment_nbreplies-"+this._listid).update(this.computeNbRepliesMsg());},activateMe:function(A){this._attachMgr._attachController.setActiveAttach(this);},deleteMe:function(A){if(!core.ServerExchange.callIsInProgress()){if(confirm(gettext("Are you sure you want to delete this comment ?"))){this._attachMgr.deleteAttach(this);}}},editMe:function(A){if(!core.ServerExchange.callIsInProgress()){this._attachMgr.editAttach(this.attach.id,0,0,this.attach.title,this.attach.content,this.attach.tags);}},toStateChoice:function(C){var B=YAHOO.util.Dom.get("current_state-"+this._listid);var A=YAHOO.util.Dom.get("select_state-"+this._listid);this._attachMgr.toStateChoice(B,A,this.attach.state_id);},toCurrentState:function(C){if(!core.ServerExchange.callIsInProgress()){var B=YAHOO.util.Dom.get("current_state-"+this._listid);var A=YAHOO.util.Dom.get("select_state-"+this._listid);this._attachMgr.toCurrentState(B,A,this.attach.state_id,this.getId(),this._attachMgr.updateAttachState,this._attachMgr);}},toNoState:function(C){var B=YAHOO.util.Dom.get("current_state-"+this._listid);var A=YAHOO.util.Dom.get("select_state-"+this._listid);this._attachMgr.switchSelect(B,A,true);},_onListOver:function(B,A){Ext.fly(this._panelid).addClass("selectAtt");},_onListOut:function(B,A){Ext.fly(this._panelid).removeClass("selectAtt");},_discsempty:function(){return Ext.fly("discs-"+this._listid).dom.innerHTML=="";},_emptydiscs:function(){Ext.fly("discs-"+this._listid).update("");},_isexpanded:function(){return Ext.fly("read-"+this._listid).hasClass("displaynone");},_read:function(A){if(!core.ServerExchange.callIsInProgress()){Ext.fly("read-"+this._listid).addClass("displaynone");Ext.fly("minimize-"+this._listid).removeClass("displaynone");Ext.fly("text-"+this._listid).removeClass("displaynone");Ext.fly("excerpt-"+this._listid).addClass("displaynone");Ext.fly("discs-"+this._listid).removeClass("displaynone");if(this._discsempty()){this.getDiscussionItems((A===true));}}},getDiscussionItems:function(A){var B=(A)?this._getDiscussionItemsReturnsAndScroll:this._getDiscussionItemsReturns;if(!sv_so_b){core.ServerExchange.send("getDiscussionItems",{"attachId":this.getId()},B,this,null,gettext("replies could not be retrieved"));}else{B.call(this,{"discussionItems":so_dis_datas[this.getId()]});}},_appendDiscussionItem:function(E){var D=this._attachMgr._readDate(E);var A=new core.DiscussionItem(D,this._attachMgr);var B=A.toDom();var C=Ext.fly("discs-"+this._listid);C.insertHtml("beforeEnd",B,false);A.connect();this._attachMgr._attachController.addDiscussionItem(A);},_getDiscussionItemsReturns:function(A){var C=A["discussionItems"];for(var B=0;B<C.length;B++){this._appendDiscussionItem(C[B]);}},_getDiscussionItemsReturnsAndScroll:function(A){this._getDiscussionItemsReturns(A);var C=Ext.ComponentMgr.get("attachsPanel").body;var B=Ext.fly("discs-"+this._listid);if(B){var E=B.last();var D=E.getY()-(C.getY()-C.dom.scrollTop)-(C.getHeight()/2);C.scrollTo("top",D,true);}},addMe:function(C){if(Ext.fly(this.getPanelId())==null){var A=this.toListItemPanel();var B=Ext.ComponentMgr.get("attachsPanel");B.add(A);if(C){B.doLayout();this.connect();}}},deleteReply:function(A){Ext.fly("disc-"+A.getId()).remove();this.attach.discussion_count=this.attach.discussion_count-1;this.refreshDiscussionItemCount();},refreshMe:function(){var A=Ext.fly("comment_title-"+this._listid);if(A){A.update(this.attach.title);}A=Ext.fly("excerpt-"+this._listid);if(A){A.update(this._getExcerpt());}A=Ext.fly("text-"+this._listid);if(A){A.update(this.attach.content);}A=Ext.fly("comment_tags-"+this._listid);if(A){A.update(this._getTags());}},removeMe:function(){Ext.ComponentMgr.get("attachsPanel").remove(this._panelid);},_minimize:function(){Ext.fly("read-"+this._listid).removeClass("displaynone");Ext.fly("minimize-"+this._listid).addClass("displaynone");Ext.fly("text-"+this._listid).addClass("displaynone");Ext.fly("excerpt-"+this._listid).removeClass("displaynone");Ext.fly("discs-"+this._listid).addClass("displaynone");},_closereply:function(){Ext.fly("reply-"+this._listid).removeClass("displaynone");Ext.fly("replyform-"+this._listid).addClass("displaynone");},_reply:function(){Ext.fly("reply-"+this._listid).addClass("displaynone");var G=Ext.fly("replyform-"+this._listid);G.removeClass("displaynone");if(G.dom.innerHTML==""){var A=_replyformtpl.applyTemplate({id:this._listid,tagslabel:gettext("Tags (comma separated)"),cook_name:core.User.getCookieAuthor(),cook_email:core.User.getCookieEMail(),authornamelabel:gettext("Name"),authoremaillabel:gettext("E-mail (will not be published)"),replytitle:gettext("Re:")+this.attach.title,replytitlelabel:gettext("Title (required)"),replytextlabel:gettext("Text (required)")});G.insertHtml("beforeEnd",A,false);var B=new Ext.Button({id:"addreply-"+this._listid,renderTo:"applyreply-"+this._listid,text:gettext("add reply")});B.on("click",this._addReplyBtnClick,this);B=new Ext.Button({id:"canceladdreply-"+this._listid,renderTo:"cancelreply-"+this._listid,text:gettext("cancel")});B.on("click",this._closereply,this);if(!sv_loggedIn){Ext.fly("add_attach_user-"+this._listid).removeClass("displaynone");}}Ext.ComponentMgr.get(this._panelid).doLayout();var D=Ext.ComponentMgr.get("attachsPanel").body;var C=Ext.fly("discs-"+this._listid);if(C){var F=Ext.fly("replyform-"+this._listid);var E=F.getY()-(D.getY()-D.dom.scrollTop)-(D.getHeight()/2);D.scrollTo("top",E,true);}},_addReplyBtnClick:function(){if(!core.ServerExchange.callIsInProgress()){var C=this._validatereply();this._displayValidationErrors(C);if(C.length==0){var B={"tags":Ext.util.Format.trim(YAHOO.util.Dom.get("discuss_comment_tags-"+this._listid).value)};var A=core.ServerExchange.send("validateTags",B,this._validateTagReturns,this);}}},_validateTagReturns:function(C){if(C!=""){this._displayValidationErrors([["discuss_comment_tags-"+this._listid,C]]);}else{var D="";var B="";if(!sv_loggedIn){D=YAHOO.util.Dom.get("discuss_author-"+this._listid).value;B=YAHOO.util.Dom.get("discuss_email-"+this._listid).value;core.User.record(D,B);}var E={"comment_id":this.getId(),"username":D,"email":B,"title":YAHOO.util.Dom.get("discuss_comment_title-"+this._listid).value,"content":YAHOO.util.Dom.get("discuss_comment_text-"+this._listid).value,"tags":YAHOO.util.Dom.get("discuss_comment_tags-"+this._listid).value};var A=core.ServerExchange.send("addDiscussionItem",E,this._addDiscussionItemReturns,this,gettext("reply added"),gettext("reply could not be added"));}},_addDiscussionItemReturns:function(C){this.attach.discussion_count=this.attach.discussion_count+1;this.refreshDiscussionItemCount();this._cleanDiscussionItemFields();this._closereply();if(C==null){alert(gettext("Thank you for your reply. It is being held for moderation."));}else{if(!this._discsempty()&&this._isexpanded()){this._appendDiscussionItem(C);var A=this._attachMgr._attachController.getDiscussionItem(C.id);var B=Ext.get(A.getDispId());if(B){var D=B.prev(".disp_discussionitem",false);this._attachMgr.setEditability(D);}}else{this._emptydiscs();this._read(true);}this._attachMgr.setEditability(Ext.get(this._listid));this._attachMgr.populateTagCloud();}},_validatereply:function(){this._cleanFormErrors();var A=[];this._attachMgr.validateComment(YAHOO.util.Dom.get("discuss_comment_title-"+this._listid),YAHOO.util.Dom.get("discuss_comment_text-"+this._listid),A);return A;},_cleanFormErrors:function(){var B=YAHOO.util.Dom.getElementsByClassName("field_error","div",this._listid);for(var A=0;A<B.length;A++){coment.util.displayYesNo(B[A],false);}},_displayValidationErrors:function(B){for(var A=0;A<B.length;A++){Ext.fly("error_"+B[A][0]).update(B[A][1]);Ext.fly("error_"+B[A][0]).removeClass("displaynone");}},connect:function(){if(!sv_so_b){Ext.fly("delete-"+this._listid).on("click",this.deleteMe,this);Ext.fly("edit-"+this._listid).on("click",this.editMe,this);Ext.fly("reply-"+this._listid).on("click",this._reply,this);Ext.fly("current_state-"+this._listid).on("click",this.toStateChoice,this);Ext.fly("select_state-"+this._listid).on("change",this.toCurrentState,this);Ext.fly("select_state-"+this._listid).on("blur",this.toNoState,this);}Ext.fly("read-"+this._listid).on("click",this._read,this);Ext.fly("minimize-"+this._listid).on("click",this._minimize,this);Ext.fly(this._listid).on("click",this.activateMe,this);Ext.fly(this._listid).on("mouseover",this._onListOver,this);Ext.fly(this._listid).on("mouseout",this._onListOut,this);},_cleanDiscussionItemFields:function(){YAHOO.util.Dom.get("discuss_comment_title-"+this._listid).value="";YAHOO.util.Dom.get("discuss_comment_text-"+this._listid).value="";YAHOO.util.Dom.get("discuss_comment_tags-"+this._listid).value="";}};initAll=function(){return{init:function(){var B=new core.AttachController();core.Language.init();core.LayoutMgr.init();Ext.ComponentMgr.get("text_frame").el.mask(Ext.get("loadingindicatormsg").dom.innerHTML,"x-mask-loading");var A=new core.CommentAttachMgr(B);core.FilterMgr.filterMgrApplyEvent.subscribe(A.onFilterMgrApply,A);core.FilterMgr.filterMgrApplyEvent.subscribe(core.TextMgr.onFilterMgrApply,core.TextMgr);core.TextMgr.register(A);Ext.ComponentMgr.get("attachsPanel").on("add",A.updateAttachCount);Ext.ComponentMgr.get("attachsPanel").on("remove",A.updateAttachCount);core.SelectionMgr.init();core.MenuMgr.init();core.FilterMgr.init();onTextAvailable=function(){var D=util.getTextDocument();var C=false;if(D){var E=D.getElementById("c_l_o_s_u_r_e");if(E){core.FilterMgr.applyallbtnclick();C=true;Ext.ComponentMgr.get("text_frame").el.unmask();}}if(coment.cst.framed){if(!C){window.setTimeout(onTextAvailable,10);}}};onTextAvailable();Ext.get("frameContainer").update("<iframe src="+sv_frameSrc+' style="width:100%;height:100%;" scrolling="auto" frameborder="0" id="frameid" name="frameid"></iframe>');if(!sv_embeded){Ext.get("tmc").setVisible(false);}}};}();